using Test
using StaticArrays
using Random

import Pkg
Pkg.activate(joinpath(@__DIR__, "../.."))
using segc_wl   # or the module name inside segc_wl.jl

input_path = joinpath(@__DIR__, "../../initial_configs/N108_L8.inp")
T_σ = 1.0 
Λ_σ = argon_deBroglie(T_σ)
println(Λ_σ)

# logQ_avg = [0.,0.,0.,0.,0.]
# seconds_avg = 0
# for _ in 1:5
sim = SimulationParams(
N_max=108,
N_min=0,
T_σ=T_σ,
Λ_σ = Λ_σ,
λ_max = 9,
r_cut_σ = 3.,
input_filename=input_path,
save_directory_path= @__DIR__ , 
maxiter=100_000_000_000_000 ) # 100 trillion iters

μstate = init_microstate(sim=sim,filename=input_path)

wl = init_WangLandauVars(sim.λ_max,sim.N_max,sim.L_σ)

cache = init_cache(sim,μstate)

initialization_check(sim,μstate,wl)

seconds = @elapsed run_simulation!(sim,μstate,wl,cache) # started at 11:05pm


#global seconds_avg += seconds
post_run(sim,μstate,wl)

logQ = correct_Q(wl)
#     for ii in 1:length(logQ)
#         logQ_avg[ii] += logQ[ii]
#     end
# end 
# logQ_avg = logQ_avg.*(1/5) # average value of partition functions over five monte carlo runs
# seconds_avg =  seconds_avg*(1/5)
println(seconds) # seconds was 140.931067834
println(logQ)
# Output:
# Wang Landau converged or reached max iterations, logf has reached 7.450580596923828e-9 and convergence is achieved when logf reaches 9.999999889225291e-9
# Iterations: 308920000 with maxiters: 100000000000000
# Total translation moves proposed: 231696858, translation moves accepted: 117078298, Acceptance ratio: 0.5053080952871618
# Total λ moves proposed: 77223142, λ moves accepted: 63834142, Acceptance ratio: 0.8266193312880225
# Final Microstate and Wang Landau variables saved
# 140.931067834
# [0.0, 14.011336997151375, 27.207859575748444, 39.957214429974556, 52.252457305788994, 63.95297412574291, 75.52257831394672, 86.20894798636436, 94.59373182058334, 102.97712022066116, 87.93522453308105, 87.15425293147564, -5.15083809196949, -398.16480350494385, -1027.9021401405334, -1444.3620859533548, -2102.7235329449177, -2609.031278848648, -3297.7532721310854, -4013.3846369981766, -4670.107993483543, -5365.855917543173, -6096.622360438108, -6827.455736666918, -7469.22847828269, -8200.053357765079, -8930.871234089136, -9661.632189691067, -10389.96884572506, -11120.800117626786, -11851.626212596893, -12582.469011425972, -13313.150652900338, -14043.960275873542, -14774.85922551155, -15505.597034558654, -16236.275345608592, -16967.112290546298, -17697.874464079738, -18428.694456622005, -19159.50339050591, -19890.174277201295, -20620.974041476846, -21351.772715255618, -22082.45300079882, -22813.242440134287, -23543.976863250136, -24274.824469685555, -25005.519944369793, -25736.284269317985, -26467.15477694571, -27197.891590178013, -27928.67557810247, -28659.355874434114, -29390.15308305621, -30120.865652248263, -30851.698102861643, -31582.536616563797, -32313.34934195876, -33044.20876336098, -33775.116090372205, -34505.89562217891, -35236.573092490435, -35967.475871399045, -36698.17174650729, -37429.06179663539, -38159.70587575436, -38890.441262975335, -39621.18657813966, -40352.041131809354, -41082.79005168378, -41813.678301513195, -42544.62492889166, -43275.54756118357, -44006.38855946064, -44737.21364748478, -45467.9035448432, -46198.73776765168, -46929.72098338604, -47660.66035531461, -48391.58357767761, -49122.57843135297, -49853.60028104484, -50584.36198671162, -51315.29883302748, -52046.1941780895, -52777.08661213517, -53507.87466080487, -54238.98397548497, -54969.769661292434, -55700.568799585104, -56431.462377399206, -57162.45389044285, -57893.45656132698, -58624.240048334, -59355.16392323375, -60086.19094593823, -60817.06240616739, -61548.031968683004, -62279.07267829776, -63010.09240733087, -63741.0547632128, -64472.036302924156, -65202.906480669975, -65933.7770883888, -66664.75779511034, -67395.35311342776, -68126.00538766384, -68861.9715693295]