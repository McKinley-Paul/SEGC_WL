using Test
using StaticArrays
using Random

import Pkg
Pkg.activate(joinpath(@__DIR__, "../.."))
using segc_wl   # or the module name inside segc_wl.jl

input_path = joinpath(@__DIR__, "../../initial_configs/N108_L8.inp")
T_σ = 1.0 
Λ_σ = argon_deBroglie(T_σ)
println(Λ_σ)

# logQ_avg = [0.,0.,0.,0.,0.]
# seconds_avg = 0
# for _ in 1:5
sim = SimulationParams(
N_max=108,
N_min=0,
T_σ=T_σ,
Λ_σ = Λ_σ,
λ_max = 9,
r_cut_σ = 2.,# 2 sigma cutoff 
input_filename=input_path,
save_directory_path= @__DIR__ , 
maxiter=100_000_000_000_000 ) # 100 trillion iters

μstate = init_microstate(sim=sim,filename=input_path)

wl = init_WangLandauVars(sim)

cache = init_cache(sim,μstate)

initialization_check(sim,μstate,wl)

cl = CellList(sim.N_max + 1, sim.r_cut_box)
make_list!(cl, μstate.N, μstate.r_box)


seconds = @elapsed run_simulation!(sim,cl,μstate,wl,cache) # started at 11:05pm


#global seconds_avg += seconds
post_run(sim,μstate,wl)

logQ = correct_Q(wl)

println(seconds) # seconds was 217 ... 1.55x longer than my original naive all pair force code ... 
println(logQ)

# Output:

# CellList: sc=3 cells per dimension  (N_max=109)
# Wang Landau converged or reached max iterations, logf has reached 7.450580596923828e-9 and convergence is achieved when logf reaches 9.999999889225291e-9
# Iterations: 317911000 with maxiters: 100000000000000
# Total translation moves proposed: 238432156, translation moves accepted: 128468238, Acceptance ratio: 0.5388041619688244
# Total λ moves proposed: 79478844, λ moves accepted: 67311436, Acceptance ratio: 0.8469101035239013
# Final Microstate and Wang Landau variables saved
# 349.459161125
# [0.0, 13.972095757722855, 27.273291870951653, 40.28165267407894, 53.01773889362812, 65.52876237034798, 77.86101551353931, 89.87446808815002, 101.92501881718636, 113.64317138493061, 124.92792883515358, 136.16285203397274, 147.20587155222893, 101.9358181655407, 39.294873997569084, 40.96788547933102, 51.051126316189766, 60.74590411782265, -63.78308528661728, -74.29693964123726, -238.1210212558508, -254.59586994349957, -548.3065345138311, -957.6778730154037, -1071.886459827423, -1330.641875386238, -1409.510705575347, -1779.2543391287327, -2463.5149469077587, -2884.18632543087, -3179.111072987318, -3879.197273686528, -4059.786660656333, -4530.080516368151, -5245.196849539876, -5712.339267775416, -6049.739202842116, -6730.655861616135, -7457.043734148145, -8188.07697661221, -8552.632920578122, -9274.28505435586, -9795.473685994744, -10334.399284020066, -10930.221759080887, -11661.328199341893, -12383.171585589647, -13085.406157881021, -13808.739153578877, -14540.134284853935, -15271.645552441478, -15996.574779942632, -16657.219807177782, -17388.62210829556, -18120.095966741443, -18851.755955934525, -19583.56182450056, -20116.806778356433, -20845.13594299555, -21577.097458854318, -22309.0277287364, -23041.238400414586, -23773.33923383057, -24498.332878753543, -25230.464149147272, -25962.84094491601, -26623.02713035047, -27355.467729851604, -28087.933127447963, -28820.50966012478, -29549.136648014188, -30281.92452993989, -31014.484649538994, -31747.690074637532, -32480.94873224199, -33214.15513546765, -33936.05541576445, -34669.37632063031, -35402.84414874017, -36136.97425028682, -36870.54949207604, -37600.31404721737, -38334.58888743818, -39068.64939939976, -39803.09840545058, -40537.692754253745, -41272.60483469069, -42008.761112973094, -42743.72638736665, -43479.452072903514, -44214.71086461842, -44950.16331060231, -45686.03131352365, -46422.91825142503, -47160.46091605723, -47897.69229158759, -48634.88676503301, -49372.757367655635, -50111.23117765784, -50850.17387020588, -51590.36178639531, -52328.394902944565, -53068.75305938721, -53809.92821799219, -54550.871000260115, -55291.895745918155, -56033.491650000215, -56569.7102406621, -56976.667085886]
#


# after taking away bounds checks cutoff some time:
# CellList: sc=3 cells per dimension  (N_max=109)
# Wang Landau converged or reached max iterations, logf has reached 7.450580596923828e-9 and convergence is achieved when logf reaches 9.999999889225291e-9
# Iterations: 232563000 with maxiters: 100000000000000
# Total translation moves proposed: 174413065, translation moves accepted: 92221952, Acceptance ratio: 0.5287559851092577
# Total λ moves proposed: 58149935, λ moves accepted: 47541352, Acceptance ratio: 0.8175650067364649
# Final Microstate and Wang Landau variables saved
# 217.118210834
# [0.0, 14.048009261488914, 27.482847839593887, 40.53591550886631, 53.24277351796627, 65.36709237098694, 77.68930731713772, 89.79164147377014, 101.68997520208359, 113.39039973914623, 125.11326466500759, 136.81219945847988, 147.3190748989582, 156.96421317756176, 157.19991458952427, 157.68221953511238, 145.03278701007366, 8.657733082771301, -19.085416957736015, -205.85702650249004, -425.1649413853884, -558.7367970347404, -611.886666148901, -661.4480057954788, -814.4179282933474, -846.6466308683157, -1284.3269966840744, -1504.5279525220394, -1859.7453703731298, -2462.3076954632998, -2839.5750841647387, -3345.9712901860476, -4017.6064066439867, -4725.283132940531, -5285.220789313316, -5915.278424143791, -6412.007146939635, -6896.168890923262, -7623.526583820581, -8262.66341495514, -8934.24842774868, -9649.141963899136, -10376.612631946802, -11105.533990442753, -11687.298085272312, -12307.140752851963, -13038.362532258034, -13768.69453445077, -14500.142821848392, -15190.320903033018, -15921.804873242974, -16653.351666733623, -17385.00629018247, -18093.068980634212, -18824.66360166669, -19556.38018207252, -20188.86021861434, -20917.527128964663, -21649.383728697896, -22381.364038288593, -23108.2438583076, -23838.337644726038, -24570.831330403686, -25302.953956618905, -26035.405506670475, -26767.633331149817, -27500.112069889903, -28220.25845746696, -28952.850383877754, -29685.491603419185, -30418.165633395314, -31150.977550715208, -31884.038712605834, -32617.377652660012, -33350.502749726176, -34083.60438717902, -34802.59462721646, -35536.449140906334, -36270.49946549535, -36980.467495426536, -37714.82285310328, -38448.63064467907, -39183.48589363694, -39918.21718546748, -40653.10118718445, -41388.80477373302, -42124.489863052964, -42859.1149238348, -43594.74638105929, -44330.342574581504, -45065.38439065218, -45801.88061963022, -46538.63795848191, -47275.06927442551, -48011.56517851353, -48748.11603717506, -49485.15468835831, -50222.50843657553, -50960.65814395249, -51699.997206792235, -52439.35834623873, -53178.53243494034, -53917.20892480016, -54656.151712208986, -55396.05704629421, -56139.08619388938, -56882.49155069888, -57492.91005834937, -58064.762453600764]

# what if we use a 2sigma cutoff?  significant speedup - 193 seconds, way closer to naive algorithm 

# CellList: sc=4 cells per dimension  (N_max=109)
# Wang Landau converged or reached max iterations, logf has reached 7.450580596923828e-9 and convergence is achieved when logf reaches 9.999999889225291e-9
# Iterations: 290118000 with maxiters: 100000000000000
# Total translation moves proposed: 217576596, translation moves accepted: 119707544, Acceptance ratio: 0.5501857561922698
# Total λ moves proposed: 72541404, λ moves accepted: 60971380, Acceptance ratio: 0.8405045482714947
# Final Microstate and Wang Landau variables saved
# 193.490408625
# [0.0, 13.96533864736557, 27.316489025950432, 40.28390288352966, 53.042679101228714, 65.33966706693172, 77.67160429060459, 89.85048727691174, 101.90699371695518, 113.67580077052116, 125.3060250878334, 136.39247035980225, 147.89820410311222, 158.8062320649624, 169.5992502719164, 180.0477844774723, 142.1465201228857, 121.8867449015379, 105.15119734406471, -105.769142344594, -114.08231772482395, -135.26885107159615, -149.21527406573296, -283.1576218008995, -294.1741911768913, -731.5030792802572, -814.9947551041842, -1435.988717481494, -1861.2831110060215, -2429.5703870505095, -2860.374591976404, -3533.0138685554266, -3626.3269681483507, -4305.767330557108, -4605.034351691604, -5301.3264581263065, -5952.346588879824, -6501.1166820675135, -7170.422997176647, -7583.170635998249, -8277.625026836991, -8426.519099459052, -8884.643138930202, -9427.04590781033, -9874.62106141448, -10507.893029779196, -11236.458742782474, -11835.084024816751, -12566.488262593746, -13277.195239752531, -13912.006744995713, -14634.28842331469, -15366.080041393638, -16097.74123801291, -16829.487060949206, -17561.187933951616, -18292.952044561505, -18883.204961657524, -19615.331166520715, -20347.57016018033, -20762.414435595274, -21494.121803864837, -22226.47541065514, -22873.22831004858, -23605.555737793446, -24337.82172678411, -25067.221311315894, -25799.86602321267, -26532.570952922106, -27265.138135045767, -27966.896765589714, -28688.135486274958, -29420.949261069298, -30153.96605631709, -30887.155125021935, -31620.228182926774, -32352.15455713868, -33085.81093509495, -33819.71152819693, -34553.87538804114, -35288.152268469334, -36022.374534249306, -36757.05877520144, -37491.04987643659, -38204.011827394366, -38939.03126114607, -39674.18713822961, -40408.753399029374, -41144.16998112202, -41880.407183751464, -42616.69995571673, -43353.468752890825, -44090.30009712279, -44826.5447486788, -45563.16974593699, -46300.79151299596, -47038.40195840597, -47776.77331830561, -48515.72014001012, -49256.57102517784, -49994.907839372754, -50734.15745228529, -51474.029052853584, -52216.12044802308, -52956.199305161834, -53697.97023743391, -54439.98103798926, -55059.86159975827, -55297.02266088128]
